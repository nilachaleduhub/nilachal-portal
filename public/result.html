<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Result | Nilachal Eduhub</title>
      <link rel=icon type=image/png href=assets/images/@mylogo.png />
<link rel="stylesheet" href="assets/css/main.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS Variables for Dark Theme */
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #0f1422;
            --bg-card: #1a1f35;
            --bg-card-hover: #222840;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --accent-gradient: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
            --accent-purple: #9333ea;
            --accent-pink: #ec4899;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.5);
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg-primary);
            color: var(--text-primary); 
            margin: 0; 
            padding-top: 80px;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .result-container {
            max-width: 1200px;
            width: 100%;
            margin: 2rem auto;
            padding: 0;
            background: transparent;
            border-radius: 0;
            box-shadow: none;
        }

        /* Header Section */
        .result-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 0 1.5rem;
        }

        .result-header h1 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            font-size: 2rem;
        }

        .result-header .subtle {
            color: var(--text-secondary);
            margin: 0;
            font-size: 0.95rem;
        }

        /* Main Content Card */
        .result-content-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        /* Score Circle Section */
        .score-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
        }

        .score-circle-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        .score-circle {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                var(--accent-purple) 0%,
                var(--accent-pink) var(--pct, 0%),
                rgba(255, 255, 255, 0.1) var(--pct, 0%),
                rgba(255, 255, 255, 0.1) 100%
            );
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            box-shadow: 0 0 30px rgba(147, 51, 234, 0.4), var(--shadow-md);
        }

        .score-circle::before {
            content: '';
            position: absolute;
            inset: 10px;
            border-radius: 50%;
            background: var(--bg-card);
            z-index: 0;
        }

        .score-circle .score-content {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .score-circle .score {
            font-size: 2.25rem;
            font-weight: 900;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 0.25rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-circle .total {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            -webkit-tap-highlight-color: transparent;
        }

        .stat-card:hover {
            background: var(--bg-card-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: rgba(147, 51, 234, 0.3);
        }

        @media (hover: none) and (pointer: coarse) {
            .stat-card:active {
                transform: scale(0.98);
                background: var(--bg-card-hover);
            }
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .stat-icon.correct {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .stat-icon.wrong {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .stat-icon.attempted {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .stat-icon.time {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .stat-icon.rank {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .stat-icon.percentile {
            background: linear-gradient(135deg, #ec4899, #db2777);
            color: white;
        }

        .stat-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            margin: 0;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        /* Meta Grid (Rank & Percentile) */
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Section Cards */
        .section-card {
            margin-top: 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--shadow-sm);
        }

        .section-card h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-weight: 800;
            font-size: 1.1rem;
        }

        .section-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .section-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(147, 51, 234, 0.3) transparent;
        }

        .section-table-wrapper::-webkit-scrollbar {
            height: 6px;
        }

        .section-table-wrapper::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        .section-table-wrapper::-webkit-scrollbar-thumb {
            background: rgba(147, 51, 234, 0.5);
            border-radius: 3px;
        }

        .section-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: rgba(147, 51, 234, 0.7);
        }

        .section-table th,
        .section-table td {
            padding: 1rem;
            text-align: left;
        }

        .section-table th {
            background: var(--bg-card);
            color: var(--text-primary);
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
        }

        .section-table tbody tr {
            background: var(--bg-secondary);
            transition: background 0.2s ease;
        }

        .section-table tbody tr:nth-child(even) {
            background: var(--bg-card);
        }

        .section-table tbody tr:hover {
            background: var(--bg-card-hover);
        }

        .section-table td {
            color: var(--text-secondary);
        }

        .section-table tbody tr td {
            color: var(--text-primary);
        }

        /* Actions/Buttons */
        .actions {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            gap: 0.875rem;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.75rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 0 6px 20px rgba(147, 51, 234, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 28px rgba(147, 51, 234, 0.5);
            filter: brightness(1.1);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1.75rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .btn-outline:hover {
            background: var(--bg-card-hover);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Tablet Responsive (768px - 1024px) */
        @media screen and (min-width: 768px) and (max-width: 1024px) {
            body {
                padding: 1rem;
            }
            .result-container {
                padding: 0;
            }
            .result-header {
                margin-bottom: 1.5rem;
            }
            .result-header h1 {
                font-size: 1.75rem;
            }
            .result-header .subtle {
                font-size: 0.9rem;
            }
            .result-content-card {
                padding: 1.75rem;
            }
            .score-section {
                margin-bottom: 1.5rem;
            }
            .score-circle {
                width: 140px;
                height: 140px;
            }
            .score-circle .score {
                font-size: 2rem;
            }
            .score-circle .total {
                font-size: 0.8rem;
            }
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.875rem;
            }
            .stat-card {
                padding: 1.125rem;
            }
            .stat-icon {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
            .stat-title {
                font-size: 0.8rem;
            }
            .stat-value {
                font-size: 1.35rem;
            }
            .meta-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.875rem;
            }
            .section-card {
                padding: 1.25rem;
                overflow-x: auto;
            }
            .section-card h3 {
                font-size: 1rem;
            }
            .section-table {
                font-size: 0.85rem;
                min-width: 600px;
            }
            .actions {
                margin-top: 1.5rem;
                flex-direction: row;
                gap: 0.875rem;
            }
            .btn, .btn-outline {
                width: auto;
                padding: 0.7rem 1.5rem;
                font-size: 0.9rem;
            }
        }

        /* Mobile Responsive */
        @media screen and (max-width: 767px) {
            body {
                padding: 0.5rem;
                padding-bottom: env(safe-area-inset-bottom, 0.5rem);
                padding-top: calc(80px + 0.5rem);
            }
            .result-container {
                padding: 0;
                max-width: 100%;
            }
            .result-header {
                margin-bottom: 1.25rem;
                padding: 0 0.75rem;
            }
            .result-header h1 {
                font-size: 1.5rem;
                line-height: 1.3;
                margin-bottom: 0.375rem;
            }
            .result-header .subtle {
                font-size: 0.85rem;
                line-height: 1.4;
            }
            .result-content-card {
                padding: 1.25rem 1rem;
                border-radius: 16px;
                margin-bottom: 1.5rem;
            }
            .score-section {
                margin-bottom: 1.75rem;
            }
            .score-circle-wrapper {
                margin-bottom: 0.75rem;
            }
            .score-circle {
                width: 150px;
                height: 150px;
            }
            .score-circle::before {
                inset: 8px;
            }
            .score-circle .score {
                font-size: 2rem;
            }
            .score-circle .total {
                font-size: 0.8rem;
                line-height: 1.2;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-bottom: 1.25rem;
            }
            .stat-card {
                padding: 1rem 0.875rem;
                border-radius: 12px;
                min-height: 90px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            .stat-card-header {
                gap: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .stat-icon {
                width: 36px;
                height: 36px;
                font-size: 1.05rem;
                flex-shrink: 0;
            }
            .stat-title {
                font-size: 0.8rem;
                line-height: 1.3;
            }
            .stat-value {
                font-size: 1.5rem;
                line-height: 1.2;
            }
            .meta-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                margin-bottom: 1.25rem;
            }
            .section-card {
                padding: 1rem 0.875rem;
                border-radius: 12px;
                overflow: visible;
            }
            .section-card h3 {
                font-size: 1rem;
                margin-bottom: 0.875rem;
            }
            .section-table-wrapper {
                margin: 0 -0.875rem;
                padding: 0 0.875rem;
            }
            .section-table {
                font-size: 0.8rem;
                min-width: 500px;
                border-radius: 8px;
            }
            .section-table th,
            .section-table td {
                padding: 0.75rem 0.625rem;
            }
            .section-table th {
                font-size: 0.75rem;
                white-space: nowrap;
            }
            .actions {
                margin-top: 1.75rem;
                flex-direction: column;
                gap: 0.75rem;
                padding-bottom: 0.5rem;
            }
            .btn, .btn-outline {
                width: 100%;
                padding: 0.875rem 1.5rem;
                font-size: 0.95rem;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 12px;
                -webkit-tap-highlight-color: rgba(147, 51, 234, 0.2);
            }
            .btn:active, .btn-outline:active {
                transform: scale(0.98);
            }
        }

        @media screen and (max-width: 480px) {
            body {
                padding: 0.375rem;
                padding-bottom: env(safe-area-inset-bottom, 0.375rem);
                padding-top: calc(80px + 0.375rem);
            }
            .result-header {
                margin-bottom: 1rem;
                padding: 0 0.5rem;
            }
            .result-header h1 {
                font-size: 1.35rem;
                line-height: 1.3;
            }
            .result-header .subtle {
                font-size: 0.8rem;
                line-height: 1.4;
            }
            .result-content-card {
                padding: 1rem 0.875rem;
                border-radius: 14px;
            }
            .score-section {
                margin-bottom: 1.5rem;
            }
            .score-circle {
                width: 140px;
                height: 140px;
            }
            .score-circle::before {
                inset: 8px;
            }
            .score-circle .score {
                font-size: 1.875rem;
            }
            .score-circle .total {
                font-size: 0.75rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.625rem;
            }
            .stat-card {
                padding: 1rem 0.875rem;
                min-height: 85px;
            }
            .stat-card-header {
                gap: 0.5rem;
            }
            .stat-icon {
                width: 34px;
                height: 34px;
                font-size: 1rem;
            }
            .stat-title {
                font-size: 0.75rem;
            }
            .stat-value {
                font-size: 1.4rem;
            }
            .meta-grid {
                gap: 0.625rem;
            }
            .section-card {
                padding: 0.875rem 0.75rem;
                border-radius: 12px;
                overflow: visible;
            }
            .section-card h3 {
                font-size: 0.95rem;
                margin-bottom: 0.75rem;
            }
            .section-table-wrapper {
                margin: 0 -0.75rem;
                padding: 0 0.75rem;
            }
            .section-table {
                font-size: 0.75rem;
                min-width: 420px;
            }
            .section-table th,
            .section-table td {
                padding: 0.625rem 0.5rem;
            }
            .section-table th {
                font-size: 0.7rem;
            }
            .actions {
                margin-top: 1.5rem;
                gap: 0.625rem;
            }
            .btn, .btn-outline {
                padding: 0.875rem 1.25rem;
                font-size: 0.9rem;
                min-height: 48px;
            }
        }

        /* Extra small devices (320px and below) */
        @media screen and (max-width: 360px) {
            body {
                padding: 0.25rem;
                padding-bottom: env(safe-area-inset-bottom, 0.25rem);
                padding-top: calc(80px + 0.25rem);
            }
            .result-header {
                padding: 0 0.5rem;
            }
            .result-header h1 {
                font-size: 1.25rem;
            }
            .result-header .subtle {
                font-size: 0.75rem;
            }
            .result-content-card {
                padding: 0.875rem 0.75rem;
            }
            .score-circle {
                width: 130px;
                height: 130px;
            }
            .score-circle .score {
                font-size: 1.75rem;
            }
            .stat-card {
                padding: 0.875rem 0.75rem;
                min-height: 80px;
            }
            .stat-value {
                font-size: 1.3rem;
            }
            .btn, .btn-outline {
                padding: 0.8rem 1.25rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
  <!-- Header / Navbar -->
  <header class="navbar">
    <a href="index.html" class="site-name" style="text-decoration: none; color: inherit;">

      <img src="assets/images/mylogo.png" alt="Nilachal Eduhub logo" class="site-logo">

      <div class="site-name-text">Nilachal <span>Eduhub</span></div>

    </a>
    
    <nav class="nav-links nav-buttons">
      <a href="index.html" class="nav-btn">Home</a>
      <a href="login-register.html" class="nav-btn" id="login-btn">Login / Register</a>
    </nav>

    <div class="search-login">
      <input type="text" class="search-box" placeholder="Search">
    </div>
  </header>

    <div class="result-container">
        <div class="result-header">
            <h1>Test Result Summary</h1>
                <p class="subtle">Here is your performance summary.</p>
        </div>

        <div class="result-content-card">
            <div class="score-section">
                <div class="score-circle-wrapper">
            <div class="score-circle" id="score-circle">
                        <div class="score-content">
                <div class="score" id="final-score">--</div>
                            <div class="total" id="total-marks">Total Score</div>
            </div>
                </div>
                </div>
                </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon correct">
                            <i class="fas fa-check-circle"></i>
                </div>
                        <h4 class="stat-title">Correct</h4>
                </div>
                    <div class="stat-value" id="total-correct">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon wrong">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <h4 class="stat-title">Wrong</h4>
                    </div>
                    <div class="stat-value" id="total-wrong">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon attempted">
                            <i class="fas fa-list-check"></i>
                        </div>
                        <h4 class="stat-title">Attempted</h4>
                    </div>
                    <div class="stat-value" id="total-attempted">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon time">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h4 class="stat-title">Time Taken</h4>
                    </div>
                    <div class="stat-value" id="time-taken">--</div>
            </div>
        </div>

        <div class="meta-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon rank">
                            <i class="fas fa-trophy"></i>
            </div>
                        <h4 class="stat-title">Rank</h4>
                    </div>
                    <div class="stat-value" id="rank">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon percentile">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h4 class="stat-title">Percentile</h4>
                    </div>
                    <div class="stat-value" id="percentile">--</div>
            </div>
        </div>

        <div class="section-card" id="section-summary" style="display:none;">
            <h3>Section-wise Summary</h3>
            <div class="section-table-wrapper">
            <table class="section-table">
                <thead>
                    <tr>
                        <th>Section</th>
                        <th>Attempted</th>
                        <th>Correct</th>
                        <th>Score</th>
                        <th>Time Taken</th>
                    </tr>
                </thead>
                <tbody id="section-tbody"></tbody>
            </table>
            </div>
        </div>

        <div class="section-card" id="section-chart-card" style="display:none;">
            <h3>Section-wise Performance</h3>
            <div id="section-chart-legend" style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
                <span style="display:inline-flex; align-items:center; gap:0.5rem;"><span style="width:12px;height:12px;background:#10b981;border-radius:3px;display:inline-block;"></span> Correct</span>
                <span style="display:inline-flex; align-items:center; gap:0.5rem;"><span style="width:12px;height:12px;background:#94a3b8;border-radius:3px;display:inline-block;"></span> Attempted</span>
                <span style="display:inline-flex; align-items:center; gap:0.5rem;"><span style="width:12px;height:12px;background:#60a5fa;border-radius:3px;display:inline-block;"></span> Score</span>
            </div>
            <svg id="section-chart" viewBox="0 0 800 0" preserveAspectRatio="none" style="width:100%;height:auto;"></svg>
        </div>

        <div class="actions">
            <a href="index.html" class="btn btn-outline">Back to Home</a>
            <a href="#" id="view-answers-btn" class="btn">View Answers</a>
        </div>


    <style>
    @media print {
        @page { size: A4 portrait; margin: 15mm; }
        body { background: white !important; color: #0b1320 !important; }
        .result-container { box-shadow: none !important; max-width: 100% !important; width: 100% !important; padding: 0 !important; }
        .result-content-card { background: white !important; border: 1px solid #e2e8f0 !important; }
        .actions, .btn, .btn-outline { display: none !important; }
        
        /* Add beautiful website header for print */
        .result-container::before {
            content: "ðŸ“˜ Nilachal Eduhub";
            display: block;
            text-align: center;
            font-size: 24px;
            font-weight: 800;
            color: #134e8b;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        /* Typography for print */
        h1, h2, h3, h4 { color: #0b1320 !important; }
        .result-header h1 { color: #0b1320 !important; }
        .result-header .subtle { color: #64748b !important; }
        .stat-title, .stat-value { color: #0b1320 !important; }
        .score-circle { border: 3px solid #e2e8f0 !important; }
        .score-circle::before { background: white !important; }
        .stat-card, .section-card { background: white !important; border: 1px solid #e2e8f0 !important; }
        #answers-list > div { background: white !important; border: 1px solid #e5e7eb; margin-bottom: 16px; padding: 12px; }
        
        /* Ensure charts and tables print well */
        svg { max-width: 100% !important; height: auto !important; }
        .section-table { border-collapse: collapse !important; }
        .section-table th, .section-table td { border: 1px solid #e2e8f0 !important; color: #0b1320 !important; }
        .section-table th { background: #f8fafc !important; }
    }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // First, check if we have query parameters (from dashboard link)
        const urlParams = new URLSearchParams(window.location.search);
        const resultId = urlParams.get('resultId');
        const testId = urlParams.get('testId');
        
        let result = null;
        let test = null;
        let answers = null;
        
        // If resultId is provided, load from server
        if (resultId) {
            try {
                const resultRes = await fetch(`/api/result/${resultId}`);
                const resultData = await resultRes.json();
                if (resultData.success && resultData.result) {
                    result = resultData.result;
                    
                    // Load test data from server
                    const testRes = await fetch(`/api/tests/${result.testId}`);
                    const testData = await testRes.json();
                    if (testData.success && testData.test) {
                        test = testData.test;
                        answers = {
                            answers: result.userAnswers || [],
                            savedAnswers: result.userAnswers || [],
                            timeTaken: result.timeTaken || 0
                        };
                    }
                }
            } catch (err) {
                console.error('Error loading result from server:', err);
                document.querySelector('.result-container').innerHTML = '<h1>Error Loading Result</h1><p>Could not load test result from server. Please try again later.</p><div class="actions"><a href="dashboard.html" class="btn">Back to Dashboard</a></div>';
                return;
            }
        } else {
            // For instant results: Try to load full test from server first
            const localResult = localStorage.getItem('testResult');
            if (localResult) {
                result = JSON.parse(localResult);
                const actualTestId = result.testId || testId;
                
                // Try to load full test from server (even for instant results)
                if (actualTestId) {
                    try {
                        const testRes = await fetch(`/api/tests/${actualTestId}`);
                        const testData = await testRes.json();
                        if (testData.success && testData.test) {
                            test = testData.test; // Full test with images from server
                            const answerData = localStorage.getItem('mockTestAnswers');
                            if (answerData) {
                                answers = JSON.parse(answerData);
                            }
                        }
                    } catch (err) {
                        console.warn('Could not load test from server, using localStorage fallback:', err);
                        // Continue with localStorage fallback below
                    }
                }
            }
        }
        
        if (!result) {
            document.querySelector('.result-container').innerHTML = '<h1>No result found.</h1><p>Please complete a test to see your results.</p><div class="actions"><a href="dashboard.html" class="btn">Back to Dashboard</a></div>';
            return;
        }
        
        // If we loaded from server, we need to calculate stats from test and answers
        if (test && answers && !result.score) {
            const posMark = parseFloat(test.positiveMark || test.marksPerQuestion || 1);
            const negMark = parseFloat(test.negativeMark || test.negativeMarks || 0);
            let attempted = 0, correct = 0, incorrect = 0, score = 0;
            
            for (let i = 0; i < test.questions.length; i++) {
                const q = test.questions[i];
                const userAns = answers.answers[i];
                const correctIndex = (q.correctAnswer !== undefined && q.correctAnswer !== null) ? q.correctAnswer
                  : (q.answer !== undefined && q.answer !== null) ? q.answer
                  : (q.correct !== undefined && q.correct !== null) ? q.correct
                  : null;
                
                if (userAns !== undefined && userAns !== null) {
                    attempted++;
                    if (correctIndex !== null && userAns === correctIndex) {
                        correct++;
                        score += posMark;
                    } else {
                        incorrect++;
                        score -= negMark;
                    }
                }
            }
            
            result.score = score;
            result.correct = correct;
            result.incorrect = incorrect;
            result.unattempted = test.questions.length - attempted;
            result.totalMarks = test.questions.length * posMark;
        }
        // Display stored result values, but validate and recalc if necessary
        let displayScore = result.score;
        let displayTotal = result.totalMarks;
        let displayCorrect = result.correct;
        let displayIncorrect = result.incorrect;
        let displayUnattempted = result.unattempted;
        let displayTime = result.timeTaken;

        // Try to recompute counts if any value is missing or NaN
        try {
            const raw = localStorage.getItem('mockTestAnswers');
            if (raw) {
                const payload = JSON.parse(raw) || {};
                const answers = payload.answers || [];
                const saved = payload.savedAnswers || result.savedAnswers || [];
                const preview = JSON.parse(localStorage.getItem('previewTest') || '{}');
                const questions = preview.questions || [];
                const posMark = parseFloat(preview.positiveMark || preview.marksPerQuestion || 1);
                const negMark = parseFloat(preview.negativeMark || preview.negativeMarks || 0);

                // Recalculate only if counts are missing or look inconsistent
                const needRecalc = [displayScore, displayCorrect, displayIncorrect, displayUnattempted].some(v => v === undefined || v === null || isNaN(v));
                if (needRecalc && questions.length > 0) {
                    let attempted = 0, correct = 0, incorrect = 0, score = 0;
                    for (let i = 0; i < questions.length; i++) {
                        const q = questions[i];
                        const ans = answers[i];
                        const correctIndex = (q.correctAnswer !== undefined && q.correctAnswer !== null) ? q.correctAnswer
                          : (q.answer !== undefined && q.answer !== null) ? q.answer
                          : (q.correct !== undefined && q.correct !== null) ? q.correct
                          : null;
                        const consideredSaved = (saved.length > 0) ? !!saved[i] : (ans !== undefined && ans !== null);
                        if (consideredSaved) {
                            attempted++;
                            if (correctIndex !== null && ans === correctIndex) {
                                correct++;
                                score += posMark;
                            } else {
                                incorrect++;
                                score -= negMark;
                            }
                        }
                    }
                    displayScore = score;
                    displayCorrect = correct;
                    displayIncorrect = incorrect;
                    displayUnattempted = questions.length - attempted;
                    displayTotal = questions.length * posMark;
                }
            }
        } catch (e) { /* ignore recalculation errors */ }

        document.getElementById('final-score').textContent = displayScore;
        document.getElementById('total-marks').textContent = `out of ${displayTotal}`;
        document.getElementById('total-attempted').textContent = (displayCorrect + displayIncorrect);
        document.getElementById('total-correct').textContent = displayCorrect;
        document.getElementById('total-wrong').textContent = displayIncorrect;
        document.getElementById('time-taken').textContent = displayTime || '--';
        // animate radial score circle fill percentage
        try {
            const pct = Math.max(0, Math.min(100, (displayScore / displayTotal) * 100));
            const scoreCircle = document.getElementById('score-circle');
            scoreCircle.style.setProperty('--pct', pct + '%');
            // Update gradient to show progress with smooth purple-to-pink transition
            if (pct > 0) {
                const midPoint = pct / 2;
                scoreCircle.style.background = `conic-gradient(
                    from 0deg,
                    #9333ea 0%,
                    #9333ea ${midPoint}%,
                    #ec4899 ${midPoint}%,
                    #ec4899 ${pct}%,
                    rgba(255, 255, 255, 0.1) ${pct}%,
                    rgba(255, 255, 255, 0.1) 100%
                )`;
            } else {
                scoreCircle.style.background = 'rgba(255, 255, 255, 0.1)';
            }
        } catch (e) {}

        // POST result to server (if not already posted) and store resultId
        let savedResultId = resultId || (result && result._id);
        if (!savedResultId) {
            try {
                const postRes = await fetch('/api/results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(result)
                });
                const postData = await postRes.json();
                if (postData.success && postData.result && postData.result._id) {
                    savedResultId = postData.result._id;
                    result._id = savedResultId; // Store for View Answers button
                }
            } catch (e) { 
                console.warn('Error posting result:', e);
            }
        }

        // Fetch all results for this test to compute rank/percentile
        let rank = '--', percentile = '--', totalParticipants = 0;
        try {
            const res = await fetch(`/api/results/${result.testId}`);
            const data = await res.json();
            if (data && data.success && Array.isArray(data.results)) {
                // Parse all scores as numbers
                const scores = data.results.map(r => {
                    const score = parseFloat(r.score);
                    return isNaN(score) ? 0 : score;
                });
                totalParticipants = scores.length;
                
                // Get user's score
                const userScore = parseFloat(result.score);
                if (isNaN(userScore)) {
                    console.warn('User score is not a valid number:', result.score);
                }
                
                if (totalParticipants > 0) {
                    // Sort descending to find rank
                    const sorted = [...scores].sort((a, b) => b - a);
                    
                    // Find rank: count how many scores are better (higher) than user's score
                    // Rank is 1-based, so if 0 scores are better, rank is 1
                    const betterScores = scores.filter(s => s > userScore).length;
                    const myRank = betterScores + 1;
                    
                    // Display rank in format "1/20"
                    rank = `${myRank}/${totalParticipants}`;
                    
                    // Percentile calculation:
                    // Percentile = ((Total participants - Rank) / Total participants) * 100
                    // This gives: rank 1 = 100%, rank 2 = 50% (if 2 participants), etc.
                    // Alternative: Percentile = (Number of scores below or equal / Total) * 100
                    // We'll use the standard formula: ((N - R + 1) / N) * 100
                    // Where N = total participants, R = rank
                    const percentileValue = ((totalParticipants - myRank + 1) / totalParticipants) * 100;
                    percentile = percentileValue.toFixed(2);
                    
                    // Debug logging
                    console.log('Rank calculation:', {
                        userScore,
                        totalParticipants,
                        betterScores,
                        myRank,
                        percentile: percentileValue
                    });
                }
            }
        } catch (e) { 
            console.error('Error calculating rank/percentile:', e);
        }
        document.getElementById('rank').textContent = rank;
        document.getElementById('percentile').textContent = percentile !== '--' ? percentile + '%' : '--';

        // Review Answers button removed by request

        // Section-wise summary (if sections exist)
        try {
            let preview = test; // Use server-loaded test if available
            if (!preview) {
                const localPreview = localStorage.getItem('previewTest');
                if (localPreview) preview = JSON.parse(localPreview);
            }
            
            let payload = answers; // Use server-loaded answers if available
            if (!payload) {
                const localPayload = localStorage.getItem('mockTestAnswers');
                if (localPayload) payload = JSON.parse(localPayload);
            }
            
            const userAnswers = payload && payload.answers ? payload.answers : [];
            const saved = payload && payload.savedAnswers ? payload.savedAnswers : [];
            const sections = preview && Array.isArray(preview.sections) ? preview.sections : [];
            const sectionalTiming = preview && !!preview.sectionalTiming;
            if (sections.length > 0 && preview && Array.isArray(preview.questions)) {
                const tbody = document.getElementById('section-tbody');
                const box = document.getElementById('section-summary');
                const pos = parseFloat(preview.positiveMark || 1);
                const neg = parseFloat(preview.negativeMark || 0);
                tbody.innerHTML = '';
                let cursor = 0;
                const secNames = [], secAttempted = [], secCorrect = [], secScores = [], secTotals = [];
                for (let si = 0; si < sections.length; si++) {
                    const s = sections[si];
                    const n = parseInt(s.numQuestions || 0);
                    let attempted = 0, correct = 0, score = 0;
                    for (let i = 0; i < n; i++) {
                        const qi = cursor + i;
                        const q = preview.questions[qi];
                        const ans = userAnswers[qi];
                        const isSaved = saved && saved.length > qi ? saved[qi] : (ans !== undefined && ans !== null);
                        if (isSaved && (ans !== undefined && ans !== null)) {
                            attempted++;
                            let correctIndex = null;
                            if (q) {
                                if (q.correctAnswer !== undefined && q.correctAnswer !== null) correctIndex = q.correctAnswer;
                                else if (q.answer !== undefined && q.answer !== null) correctIndex = q.answer;
                                else if (q.correct !== undefined && q.correct !== null) correctIndex = q.correct;
                                if (correctIndex !== null && ans === correctIndex) {
                                    correct++;
                                    score += pos;
                                } else {
                                    score -= neg;
                                }
                            }
                        }
                    }
                    // section time: show measured if available (payload.sectionTimeTaken), else fallback
                    let secTime = 'â€”';
                    if (payload && Array.isArray(payload.sectionTimeTaken) && typeof payload.sectionTimeTaken[si] === 'number') {
                        const spent = payload.sectionTimeTaken[si];
                        const m = Math.floor(spent / 60); const se = spent % 60;
                        secTime = `${m}:${String(se).padStart(2,'0')}`;
                    } else if (sectionalTiming && s.timeLimit) {
                        secTime = `${s.timeLimit} mins`;
                    }
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${s.name || ('Section ' + (si+1))}</td>
                        <td>${attempted}/${n}</td>
                        <td>${correct}</td>
                        <td>${score}</td>
                        <td>${secTime}</td>
                    `;
                    tbody.appendChild(tr);
                    secNames.push(s.name || ('Section ' + (si+1)));
                    secAttempted.push(attempted);
                    secCorrect.push(correct);
                    secScores.push(score);
                    secTotals.push(n);
                    cursor += n;
                }
                box.style.display = '';

                // Render lightweight SVG vertical bar chart (grouped bars per section)
                try {
                    const svg = document.getElementById('section-chart');
                    const card = document.getElementById('section-chart-card');
                    const width = 800; // viewBox width
                    const height = 300; // viewBox height
                    const paddingL = 60; // space for labels
                    const paddingR = 20;
                    const paddingT = 20;
                    const paddingB = 60; // space for x-axis labels
                    const chartWidth = width - paddingL - paddingR;
                    const chartHeight = height - paddingT - paddingB;
                    
                    svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
                    
                    // Scale by max values
                    const maxCount = Math.max(1, ...secTotals);
                    const maxScore = Math.max(1, ...secScores.map(v => Math.abs(v)));
                    const maxValue = Math.max(maxCount, maxScore);
                    
                    const barGroupWidth = chartWidth / secNames.length;
                    const barWidth = barGroupWidth * 0.12; // width of each individual bar (reduced from 0.2)
                    const barSpacing = barGroupWidth * 0.08; // spacing between bars in a group (reduced from 0.1)
                    
                    let content = '';
                    
                    // Y-axis grid lines and labels
                    for (let i = 0; i <= 5; i++) {
                        const value = (maxValue / 5) * i;
                        const y = paddingT + chartHeight - (i / 5) * chartHeight;
                        content += `<line x1="${paddingL}" y1="${y}" x2="${width - paddingR}" y2="${y}" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="2,2" />`;
                        content += `<text x="${paddingL - 8}" y="${y + 4}" font-size="10" fill="#64748b" text-anchor="end">${Math.round(value)}</text>`;
                    }
                    
                    // Bars for each section
                    for (let i = 0; i < secNames.length; i++) {
                        const groupX = paddingL + (i * barGroupWidth) + (barGroupWidth / 2);
                        const baseX = groupX - (barWidth * 1.5) - barSpacing;
                        
                        // Correct bar (green)
                        const correctHeight = (secCorrect[i] / maxValue) * chartHeight;
                        const correctY = paddingT + chartHeight - correctHeight;
                        content += `<rect x="${baseX}" y="${correctY}" width="${barWidth}" height="${correctHeight}" fill="#10b981" rx="2" />`;
                        
                        // Attempted bar (gray)
                        const attemptedHeight = (secAttempted[i] / maxValue) * chartHeight;
                        const attemptedY = paddingT + chartHeight - attemptedHeight;
                        content += `<rect x="${baseX + barWidth + barSpacing}" y="${attemptedY}" width="${barWidth}" height="${attemptedHeight}" fill="#94a3b8" rx="2" />`;
                        
                        // Score bar (blue)
                        const scoreHeight = (Math.max(0, secScores[i]) / maxValue) * chartHeight;
                        const scoreY = paddingT + chartHeight - scoreHeight;
                        content += `<rect x="${baseX + (barWidth + barSpacing) * 2}" y="${scoreY}" width="${barWidth}" height="${scoreHeight}" fill="#60a5fa" rx="2" />`;
                        
                        // Section label
                        content += `<text x="${groupX}" y="${height - paddingB + 15}" font-size="11" fill="#334155" text-anchor="middle">${secNames[i]}</text>`;
                        
                        // Value labels on bars
                        if (secCorrect[i] > 0) {
                            content += `<text x="${baseX + barWidth/2}" y="${correctY - 4}" font-size="9" fill="#0f172a" text-anchor="middle">${secCorrect[i]}</text>`;
                        }
                        if (secAttempted[i] > 0) {
                            content += `<text x="${baseX + barWidth + barSpacing + barWidth/2}" y="${attemptedY - 4}" font-size="9" fill="#0f172a" text-anchor="middle">${secAttempted[i]}</text>`;
                        }
                        if (secScores[i] > 0) {
                            content += `<text x="${baseX + (barWidth + barSpacing) * 2 + barWidth/2}" y="${scoreY - 4}" font-size="9" fill="#0f172a" text-anchor="middle">${secScores[i]}</text>`;
                        }
                    }
                    
                    // Y-axis label
                    content += `<text x="15" y="${height/2}" font-size="12" fill="#334155" text-anchor="middle" transform="rotate(-90, 15, ${height/2})">Count / Score</text>`;
                    
                    svg.innerHTML = content;
                    card.style.display = '';
                } catch (e) { /* ignore chart errors */ }
            }
        } catch (e) { /* ignore */ }

        // Setup View Answers button
        const viewAnswersBtn = document.getElementById('view-answers-btn');
        if (viewAnswersBtn) {
            // Store savedResultId in a variable accessible to the click handler
            let finalResultId = savedResultId || resultId || (result && result._id);
            let finalTestId = testId || (result && result.testId);
            
            viewAnswersBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // Get resultId or create navigation URL
                let navUrl = 'view-answers.html?';
                if (finalResultId) {
                    navUrl += `resultId=${finalResultId}`;
                } else if (finalTestId) {
                    navUrl += `testId=${finalTestId}`;
                } else {
                    // Fallback: try to get from localStorage
                    const localResult = localStorage.getItem('testResult');
                    if (localResult) {
                        try {
                            const parsedResult = JSON.parse(localResult);
                            if (parsedResult._id) {
                                navUrl += `resultId=${parsedResult._id}`;
                            } else if (parsedResult.testId) {
                                navUrl += `testId=${parsedResult.testId}`;
                            } else {
                                alert('Unable to load answers. Please try again.');
                                return;
                            }
                        } catch (err) {
                            console.error('Error parsing result from localStorage:', err);
                            alert('Unable to load answers. Please try again.');
                            return;
                        }
                    } else {
                        alert('Unable to load answers. Please try again.');
                        return;
                    }
                }
                window.location.href = navUrl;
            });
        }

    });
    </script>
  <script src="assets/js/search.js"></script>
  <script>
    // Check if user is already logged in and hide login button
    document.addEventListener('DOMContentLoaded', function() {
      const loginBtn = document.getElementById('login-btn');
      const user = localStorage.getItem('user');
      
      if (user && loginBtn) {
        loginBtn.style.display = 'none';
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Course Details | Nilachal Eduhub</title>
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/category.css">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

  <!-- Header / Navbar -->
  <header class="navbar">
    <div class="site-name">

      <img src="assets/images/mylogo.png" alt="Nilachal Eduhub logo" class="site-logo">

      <div class="site-name-text">Nilachal <span>Eduhub</span></div>

    </div>

    <nav class="nav-links nav-buttons">
      <a href="index.html" class="nav-btn">Home</a>
      <a href="buy-course.html" class="nav-btn">← Back to Buy Course</a>
      <a href="login-register.html" class="nav-btn" id="login-btn">Login / Register</a>
    </nav>
  </header>

  <!-- Detail Content -->
  <div class="containernew detail-wrapper">
    <div id="detail-card" class="detail-card" style="display:none;">
      <h1 id="detail-title">Loading...</h1>
      <p id="detail-subtitle" class="detail-subtitle" style="display:none;"></p>

      <div id="detail-meta" class="detail-meta"></div>

      <p id="detail-description" class="detail-description" style="display:none;"></p>

      <section id="detail-course-details-section" class="detail-section" style="display:none;">
        <h2>Course Details</h2>
        <ul id="detail-list" class="detail-list"></ul>
      </section>

      <div id="detail-price-summary" class="detail-price-summary" style="display:none; margin-top:16px;"></div>

      <div id="detail-discount-section" class="detail-discount" style="display:none; margin-top:12px;">
        <p id="detail-discount-message" class="detail-discount-message"></p>
        <div class="detail-discount-input" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <input type="text" id="detail-discount-code-input" placeholder="Enter discount code" style="flex:1 1 200px; padding:10px; border-radius:8px; border:1px solid #d1d5db;">
          <button type="button" id="detail-apply-discount-btn" class="detail-discount-apply-btn" style="padding:10px 18px; border:none; border-radius:8px; background:#2563eb; color:#fff; cursor:pointer;">Apply</button>
        </div>
        <p id="detail-discount-feedback" class="detail-discount-feedback" style="display:none; margin-top:8px; font-weight:600;"></p>
      </div>

      <section id="detail-courses-section" class="detail-section" style="display:none;">
        <h2>Included Courses</h2>
        <div id="detail-courses" class="detail-courses-grid"></div>
      </section>

      <button id="detail-buy-btn" class="detail-buy-btn">Buy Now</button>
    </div>

    <p id="detail-empty" class="detail-empty" style="display:none;"></p>
  </div>

  <script>
    (() => {
      const params = new URLSearchParams(window.location.search);
      const type = params.get('type');
      const entityId = params.get('id');
      const initialCategoryId = params.get('categoryId');

      const detailCard = document.getElementById('detail-card');
      const emptyEl = document.getElementById('detail-empty');
      const titleEl = document.getElementById('detail-title');
      const subtitleEl = document.getElementById('detail-subtitle');
      const metaEl = document.getElementById('detail-meta');
      const descriptionEl = document.getElementById('detail-description');
      const detailsSection = document.getElementById('detail-course-details-section');
      const detailsListEl = document.getElementById('detail-list');
      const coursesSection = document.getElementById('detail-courses-section');
      const coursesGrid = document.getElementById('detail-courses');
      const buyBtn = document.getElementById('detail-buy-btn');
      const priceSummaryEl = document.getElementById('detail-price-summary');
      const discountSection = document.getElementById('detail-discount-section');
      const discountMessageEl = document.getElementById('detail-discount-message');
      const discountCodeInput = document.getElementById('detail-discount-code-input');
      const discountApplyBtn = document.getElementById('detail-apply-discount-btn');
      const discountFeedbackEl = document.getElementById('detail-discount-feedback');

      const pricingState = {
        baseAmount: 0,
        currencySymbol: '₹',
        discountActive: false,
        discountPercent: 0,
        discountCode: '',
        discountMessage: '',
        appliedDiscount: false,
        appliedCode: '',
        finalAmount: 0,
        rawPrice: ''
      };

      const VALIDITY_UNITS = ['day', 'month', 'year'];

      const parseValidityString = (input) => {
        if (!input) return { value: null, unit: '' };
        const trimmed = String(input).toLowerCase();
        const match = trimmed.match(/(\d+)\s*(day|days|month|months|year|years)/);
        if (!match) return { value: null, unit: '' };
        const value = parseInt(match[1], 10);
        if (Number.isNaN(value) || value <= 0) return { value: null, unit: '' };
        let unit = match[2];
        if (unit.endsWith('s')) unit = unit.slice(0, -1);
        if (!VALIDITY_UNITS.includes(unit)) return { value: null, unit: '' };
        return { value, unit };
      };

      const formatValidityString = (value, unit) => {
        if (!value || !unit) return '';
        const suffix = value === 1 ? unit : `${unit}s`;
        return `${value} ${suffix}`;
      };

      const deriveValidityForItem = (item = {}) => {
        if (!item) return { courseValidity: '', validityValue: null, validityUnit: '' };
        let { courseValidity = '', validityValue = null, validityUnit = '' } = item;

        if ((!validityValue || !validityUnit) && courseValidity) {
          const parsed = parseValidityString(courseValidity);
          validityValue = parsed.value;
          validityUnit = parsed.unit;
        }

        if (validityValue && !validityUnit) validityUnit = '';

        if (validityValue && validityUnit && !courseValidity) {
          courseValidity = formatValidityString(validityValue, validityUnit);
        }

        return {
          courseValidity: courseValidity || '',
          validityValue: validityValue || null,
          validityUnit: validityValue ? validityUnit : ''
        };
      };

      const computeExpiryDate = (value, unit, baseDate = new Date()) => {
        if (!value || !unit || !VALIDITY_UNITS.includes(unit)) return null;
        const expiry = new Date(baseDate);
        switch (unit) {
          case 'day':
            expiry.setDate(expiry.getDate() + value);
            break;
          case 'month':
            expiry.setMonth(expiry.getMonth() + value);
            break;
          case 'year':
            expiry.setFullYear(expiry.getFullYear() + value);
            break;
          default:
            return null;
        }
        return expiry;
      };

      const extractPriceInfo = (input) => {
        if (input === undefined || input === null) {
          return { amount: 0, symbol: '₹', raw: '' };
        }
        const raw = String(input).trim();
        const numericPart = raw.replace(/[^0-9.,]/g, '');
        let amount = parseFloat(numericPart.replace(/,/g, ''));
        if (Number.isNaN(amount)) amount = 0;
        const symbolMatch = raw.match(/[^0-9.,\s]/);
        const symbol = symbolMatch ? symbolMatch[0] : '₹';
        return { amount, symbol, raw };
      };

      const formatAmount = (amount, symbol, rawFallback = '') => {
        if ((!amount || Number.isNaN(amount)) && rawFallback) {
          return rawFallback;
        }
        const safeAmount = Number.isNaN(amount) ? 0 : amount;
        const formatted = Number.isInteger(safeAmount) ? safeAmount.toFixed(0) : safeAmount.toFixed(2);
        return `${symbol}${formatted.replace(/\.00$/, '')}`;
      };

      const resetDiscountFeedback = () => {
        if (discountFeedbackEl) {
          discountFeedbackEl.style.display = 'none';
          discountFeedbackEl.textContent = '';
          discountFeedbackEl.style.color = '';
        }
      };

      const updatePriceSummary = () => {
        if (!priceSummaryEl) return;
        if ((!pricingState.rawPrice || pricingState.rawPrice === '') && pricingState.baseAmount === 0) {
          priceSummaryEl.style.display = 'none';
          priceSummaryEl.innerHTML = '';
          return;
        }
        const baseDisplay = formatAmount(pricingState.baseAmount, pricingState.currencySymbol, pricingState.rawPrice);
        let content = `<strong>Price:</strong> ${baseDisplay}`;
        if (pricingState.appliedDiscount && pricingState.finalAmount < pricingState.baseAmount) {
          const finalDisplay = formatAmount(pricingState.finalAmount, pricingState.currencySymbol, pricingState.rawPrice);
          content = `<strong>Price:</strong> ${baseDisplay} → ${finalDisplay} (after discount)`;
        }
        priceSummaryEl.innerHTML = content;
        priceSummaryEl.style.display = 'block';
      };

      const renderDiscountSection = () => {
        if (!discountSection) return;
        resetDiscountFeedback();
        if (pricingState.discountActive) {
          discountSection.style.display = 'block';
          if (discountMessageEl) {
            const fallbackMessage = pricingState.discountCode
              ? `Use code ${pricingState.discountCode} to get ${pricingState.discountPercent}% off.`
              : `Enjoy ${pricingState.discountPercent}% off!`;
            discountMessageEl.textContent = pricingState.discountMessage || fallbackMessage;
          }
          if (discountCodeInput) discountCodeInput.value = '';
          if (discountApplyBtn) {
            discountApplyBtn.disabled = false;
            discountApplyBtn.textContent = 'Apply';
          }
        } else {
          discountSection.style.display = 'none';
          if (discountCodeInput) discountCodeInput.value = '';
        }
      };

      const initialisePricingForItem = (item = {}) => {
        const priceInfo = extractPriceInfo(item.courseCost);
        pricingState.baseAmount = priceInfo.amount > 0 ? priceInfo.amount : 0;
        pricingState.currencySymbol = priceInfo.symbol || '₹';
        pricingState.rawPrice = priceInfo.raw || '';

        const validityDetails = deriveValidityForItem(item);
        if (validityDetails.courseValidity) item.courseValidity = validityDetails.courseValidity;
        if (validityDetails.validityValue) item.validityValue = validityDetails.validityValue;
        if (validityDetails.validityUnit) item.validityUnit = validityDetails.validityUnit;

        pricingState.discountActive = !!item.hasDiscount && !!item.discountPercent && !!item.discountCode;
        pricingState.discountPercent = item.discountPercent || 0;
        pricingState.discountCode = item.discountCode ? String(item.discountCode).trim().toUpperCase() : '';
        pricingState.discountMessage = item.discountMessage || '';
        pricingState.appliedDiscount = false;
        pricingState.appliedCode = '';
        pricingState.finalAmount = pricingState.baseAmount;
        updatePriceSummary();
        renderDiscountSection();
      };

      const applyDiscountCode = () => {
        if (!pricingState.discountActive) return;
        if (!discountCodeInput) return;

        const inputCode = discountCodeInput.value ? discountCodeInput.value.trim().toUpperCase() : '';
        if (!inputCode) {
          if (discountFeedbackEl) {
            discountFeedbackEl.textContent = 'Please enter a discount code.';
            discountFeedbackEl.style.display = 'block';
            discountFeedbackEl.style.color = '#dc2626';
          }
          return;
        }

        if (inputCode !== pricingState.discountCode) {
          pricingState.appliedDiscount = false;
          pricingState.appliedCode = '';
          pricingState.finalAmount = pricingState.baseAmount;
          updatePriceSummary();
          if (discountFeedbackEl) {
            discountFeedbackEl.textContent = 'Invalid discount code. Please try again.';
            discountFeedbackEl.style.display = 'block';
            discountFeedbackEl.style.color = '#dc2626';
          }
          if (discountApplyBtn) {
            discountApplyBtn.disabled = false;
            discountApplyBtn.textContent = 'Apply';
          }
          return;
        }

        const savings = pricingState.baseAmount * (pricingState.discountPercent / 100);
        const discounted = pricingState.baseAmount - savings;
        pricingState.appliedDiscount = true;
        pricingState.appliedCode = pricingState.discountCode;
        pricingState.finalAmount = Math.max(0, parseFloat(discounted.toFixed(2)));
        updatePriceSummary();
        if (discountFeedbackEl) {
          const savingsDisplay = formatAmount(savings, pricingState.currencySymbol);
          discountFeedbackEl.textContent = `Discount applied! You save ${savingsDisplay}.`;
          discountFeedbackEl.style.display = 'block';
          discountFeedbackEl.style.color = '#16a34a';
        }
        if (discountApplyBtn) {
          discountApplyBtn.disabled = true;
          discountApplyBtn.textContent = 'Applied';
        }
      };

      if (discountApplyBtn) {
        discountApplyBtn.addEventListener('click', (event) => {
          event.preventDefault();
          applyDiscountCode();
        });
      }

      if (discountCodeInput) {
        discountCodeInput.addEventListener('input', () => {
          resetDiscountFeedback();
          if (discountApplyBtn) {
            discountApplyBtn.disabled = false;
            discountApplyBtn.textContent = 'Apply';
          }
        });
        discountCodeInput.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            applyDiscountCode();
          }
        });
      }
      const loginBtn = document.getElementById('login-btn');
      const storedUser = localStorage.getItem('user');
      if (storedUser && loginBtn) {
        loginBtn.style.display = 'none';
      }

      const getEntityId = (entity) => {
        if (!entity) return null;
        return entity.id || entity._id || null;
      };

      const uniqueById = (items = []) => {
        const map = new Map();
        items.forEach(item => {
          const key = getEntityId(item);
          if (!item || !key) return;
          if (!map.has(key)) {
            map.set(key, item);
          }
        });
        return Array.from(map.values());
      };

      const showError = (message) => {
        if (detailCard) detailCard.style.display = 'none';
        if (emptyEl) {
          emptyEl.textContent = message;
          emptyEl.style.display = 'block';
        }
      };

      const showCard = () => {
        if (emptyEl) emptyEl.style.display = 'none';
        if (detailCard) detailCard.style.display = 'block';
      };

      const normaliseDetailLines = (input) => {
        if (!input) return [];
        if (Array.isArray(input)) {
          return input
            .map(item => String(item || '').trim())
            .filter(Boolean);
        }
        return String(input)
          .replace(/[•·]/g, '\n')
          .split(/\r?\n/)
          .map(line => line.replace(/^[\s\-\*•·]+/, '').trim())
          .filter(Boolean);
      };

      const createDetailPill = (label, value) => {
        const pill = document.createElement('span');
        pill.className = 'card-detail';

        const labelSpan = document.createElement('span');
        labelSpan.className = 'card-detail-label';
        labelSpan.textContent = label;

        const valueSpan = document.createElement('span');
        valueSpan.className = 'card-detail-value';
        valueSpan.textContent = String(value);

        pill.appendChild(labelSpan);
        pill.appendChild(document.createTextNode(': '));
        pill.appendChild(valueSpan);
        return pill;
      };

      const buildMeta = (items = []) => {
        if (!metaEl) return;
        metaEl.innerHTML = '';
        items.forEach(item => {
          if (!item || item.value === undefined || item.value === null || String(item.value).trim() === '') return;
          metaEl.appendChild(createDetailPill(item.label, item.value));
        });
      };

      const fetchJson = async (url) => {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error('Request failed');
          return await res.json();
        } catch (err) {
          console.warn('Request error for', url, err);
          return null;
        }
      };

      let categoriesCache = null;
      const fetchCategories = async () => {
        if (categoriesCache) return categoriesCache;

        let publicCategories = [];
        let adminCategories = [];
        let legacyCategories = [];

        // Public API (available to all users)
        try {
          const publicData = await fetchJson('/api/categories');
          if (publicData && publicData.success && Array.isArray(publicData.categories)) {
            publicCategories = publicData.categories;
          }
        } catch (err) {
          console.warn('Unable to load categories from public API:', err);
        }

        // Admin API (fallback if public API unavailable)
        try {
          const adminData = await fetchJson('/api/admin/categories');
          if (adminData && adminData.success && Array.isArray(adminData.categories)) {
            adminCategories = adminData.categories;
          }
        } catch (err) {
          console.warn('Unable to load categories from admin API:', err);
        }

        // Legacy sources: static file + localStorage
        try {
          const res = await fetch('assets/data/categories.json');
          if (res && res.ok) {
            const fileData = await res.json();
            if (Array.isArray(fileData)) {
              legacyCategories = fileData;
            }
          }
        } catch (err) {
          console.warn('Unable to load categories from file:', err);
        }

        try {
          const storedAdmin = JSON.parse(localStorage.getItem('adminCategories') || '[]');
          const storedMain = JSON.parse(localStorage.getItem('mainCategories') || '[]');
          legacyCategories = [...legacyCategories, ...storedAdmin, ...storedMain];
        } catch (err) {
          console.warn('Unable to read categories from localStorage:', err);
        }

        const combined = [...publicCategories, ...adminCategories, ...legacyCategories];
        categoriesCache = uniqueById(combined);
        return categoriesCache;
      };

      let examsCache = null;
      const fetchExams = async () => {
        if (examsCache) return examsCache;
        const data = await fetchJson('/api/exams');
        if (data && data.success && Array.isArray(data.exams)) {
          examsCache = data.exams;
          return examsCache;
        }
        examsCache = [];
        return examsCache;
      };

      const coursesCache = new Map();
      const fetchCourses = async (categoryId) => {
        if (!categoryId) return [];
        if (coursesCache.has(categoryId)) return coursesCache.get(categoryId);
        const encoded = encodeURIComponent(categoryId);
        const data = await fetchJson(`/api/admin/courses/${encoded}`);
        if (data && data.success && Array.isArray(data.courses)) {
          coursesCache.set(categoryId, data.courses);
          return data.courses;
        }
        coursesCache.set(categoryId, []);
        return [];
      };

      const renderCourses = (courses = [], activeCourseId, derivedCategoryId) => {
        if (!coursesGrid || !coursesSection) return;
        if (!courses || courses.length === 0) {
          coursesSection.style.display = 'none';
          coursesGrid.innerHTML = '';
          return;
        }

        coursesSection.style.display = 'block';
        coursesGrid.innerHTML = '';

        courses.forEach(course => {
          const courseId = getEntityId(course);
          if (activeCourseId && courseId === activeCourseId) return;

          const link = document.createElement('a');
          link.className = 'detail-course-chip';

          const params = new URLSearchParams();
          params.set('type', 'course');
          if (courseId) params.set('id', courseId);
          const categoryId = course.categoryId || derivedCategoryId;
          if (categoryId) params.set('categoryId', categoryId);
          link.href = `buy-course-details.html?${params.toString()}`;

          const nameEl = document.createElement('strong');
          nameEl.textContent = course.name || 'Course';
          link.appendChild(nameEl);

          if (course.courseCost) {
            const priceEl = document.createElement('span');
            priceEl.textContent = `Price: ${course.courseCost}`;
            link.appendChild(priceEl);
          }

          if (course.courseValidity) {
            const validityEl = document.createElement('span');
            validityEl.textContent = `Validity: ${course.courseValidity}`;
            link.appendChild(validityEl);
          }

          coursesGrid.appendChild(link);
        });

        if (!coursesGrid.childElementCount) {
          coursesSection.style.display = 'none';
        }
      };

      const renderDetail = ({ item, metaItems, detailLines, description, relatedCourses, categoryName, derivedCategoryId, currentCourseId }) => {
        showCard();
        if (item) {
          initialisePricingForItem(item);
        }

        titleEl.textContent = item.name || 'Course Details';

        if (categoryName) {
          subtitleEl.textContent = categoryName;
          subtitleEl.style.display = 'block';
        } else if (type === 'category') {
          subtitleEl.textContent = 'Category Overview';
          subtitleEl.style.display = 'block';
        } else {
          subtitleEl.style.display = 'none';
        }

        buildMeta(metaItems);

        if (description) {
          descriptionEl.textContent = description;
          descriptionEl.style.display = 'block';
        } else {
          descriptionEl.style.display = 'none';
        }

        if (detailLines.length > 0) {
          detailsSection.style.display = 'block';
          detailsListEl.innerHTML = '';
          detailLines.forEach(line => {
            const li = document.createElement('li');
            li.textContent = line;
            detailsListEl.appendChild(li);
          });
        } else {
          detailsSection.style.display = 'none';
        }

        renderCourses(relatedCourses, currentCourseId, derivedCategoryId);

        buyBtn.onclick = async () => {
          // Check if user is logged in
          const storedUser = localStorage.getItem('user');
          if (!storedUser) {
            try {
              const priceDisplay = formatAmount(pricingState.finalAmount > 0 ? pricingState.finalAmount : pricingState.baseAmount, pricingState.currencySymbol, pricingState.rawPrice);
              const validityDetails = deriveValidityForItem(item);
              const provisionalExpiry = validityDetails.validityValue && validityDetails.validityUnit
                ? computeExpiryDate(validityDetails.validityValue, validityDetails.validityUnit, new Date())
                : null;
              const payload = {
                type,
                id: getEntityId(item),
                categoryId: derivedCategoryId || null,
                name: item.name || '',
                price: priceDisplay,
                basePrice: pricingState.baseAmount,
                finalPrice: pricingState.finalAmount,
                currencySymbol: pricingState.currencySymbol,
                discountApplied: pricingState.appliedDiscount,
                discountCode: pricingState.appliedDiscount ? pricingState.appliedCode : '',
                discountPercent: pricingState.appliedDiscount ? pricingState.discountPercent : 0,
                courseValidity: validityDetails.courseValidity || null,
                validityValue: validityDetails.validityValue,
                validityUnit: validityDetails.validityUnit,
                provisionalExpiresAt: provisionalExpiry ? provisionalExpiry.toISOString() : null,
                timestamp: Date.now()
              };
              localStorage.setItem('selectedProduct', JSON.stringify(payload));
            } catch (err) {
              console.warn('Unable to persist selected product:', err);
            }
            window.location.href = 'login-register.html';
            return;
          }

          // User is logged in, proceed with payment
          let user = null;
          try {
            user = JSON.parse(storedUser);
          } catch (err) {
            console.error('Error parsing user data:', err);
            alert('Please login again');
            window.location.href = 'login-register.html';
            return;
          }

          if (!user || !user.id) {
            alert('Please login to continue');
            window.location.href = 'login-register.html';
            return;
          }

          // Get price from item
          const payableAmount = pricingState.finalAmount > 0 ? pricingState.finalAmount : pricingState.baseAmount;

          if (payableAmount <= 0) {
            alert('Invalid price. Please contact support.');
            return;
          }

          // Disable button during payment process
          buyBtn.disabled = true;
          buyBtn.textContent = 'Processing...';

          try {
            // Create Razorpay order
            const orderResponse = await fetch('/api/payment/create-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                amount: payableAmount,
                currency: 'INR',
                userId: user.id || user._id || user.email,
                purchaseType: type,
                purchaseId: getEntityId(item),
                purchaseName: item.name || '',
                categoryId: derivedCategoryId || null,
                discountCode: pricingState.appliedDiscount ? pricingState.appliedCode : '',
                discountPercent: pricingState.appliedDiscount ? pricingState.discountPercent : 0
              })
            });

            const orderData = await orderResponse.json();

            if (!orderData.success) {
              throw new Error(orderData.message || 'Failed to create order');
            }

            // Get Razorpay key
            const keyResponse = await fetch('/api/payment/key');
            const keyData = await keyResponse.json();

            if (!keyData.success) {
              throw new Error('Razorpay not configured');
            }

            // Initialize Razorpay checkout
            const options = {
              key: keyData.keyId,
              amount: orderData.amount,
              currency: orderData.currency,
              order_id: orderData.orderId,
              name: 'Nilachal Eduhub',
              description: `Purchase: ${item.name || 'Course/Test'}`,
              prefill: {
                name: user.name || '',
                email: user.email || '',
                contact: user.phone || ''
              },
              theme: {
                color: '#00bfff'
              },
              handler: async function (response) {
                try {
                  // Verify payment
                  const verifyResponse = await fetch('/api/payment/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      razorpay_order_id: response.razorpay_order_id,
                      razorpay_payment_id: response.razorpay_payment_id,
                      razorpay_signature: response.razorpay_signature,
                      userId: user.id || user._id || user.email
                    })
                  });

                  const verifyData = await verifyResponse.json();

                  if (verifyData.success) {
                    // Save purchase to localStorage for dashboard
                    try {
                      const validityDetails = deriveValidityForItem(item);
                      const purchaseTimestamp = new Date();
                      const expiresAtLocal = validityDetails.validityValue && validityDetails.validityUnit
                        ? computeExpiryDate(validityDetails.validityValue, validityDetails.validityUnit, purchaseTimestamp)
                        : null;

                      const purchaseData = {
                        type: type, // Preserve the actual purchase type (course, test, category, exam)
                        purchaseType: type, // Also store as purchaseType for consistency
                        id: getEntityId(item),
                        categoryId: derivedCategoryId || null,
                        name: item.name || '',
                        description: item.description || '',
                        examName: item.examName || '',
                        courseValidity: validityDetails.courseValidity || null,
                        validityValue: validityDetails.validityValue,
                        validityUnit: validityDetails.validityUnit,
                        userId: user.id || user._id || user.email,
                        purchasedAt: purchaseTimestamp.toISOString(),
                        expiresAt: expiresAtLocal ? expiresAtLocal.toISOString() : null,
                        pricePaid: payableAmount,
                        priceDisplay: formatAmount(payableAmount, pricingState.currencySymbol, pricingState.rawPrice),
                        basePrice: pricingState.baseAmount,
                        discountApplied: pricingState.appliedDiscount,
                        discountCode: pricingState.appliedDiscount ? pricingState.appliedCode : '',
                        discountPercent: pricingState.appliedDiscount ? pricingState.discountPercent : 0
                      };

                      let userPurchases = null;
                      try {
                        userPurchases = JSON.parse(localStorage.getItem('userPurchases') || '{}');
                      } catch (e) {
                        userPurchases = {};
                      }

                      const userId = user.id || user._id || user.email;
                      if (!userPurchases[userId]) {
                        userPurchases[userId] = { courses: [], tests: [] };
                      }

                      // Handle renewals: check if purchase already exists and update it instead of creating duplicate
                      const purchaseId = getEntityId(item);
                      let existingPurchaseIndex = -1;
                      let targetArray = null;

                      // Determine which array to check based on purchase type
                      if (type === 'course' || type === 'category' || type === 'exam') {
                        targetArray = userPurchases[userId].courses;
                      } else if (type === 'test') {
                        targetArray = userPurchases[userId].tests;
                      }

                      // Find existing purchase with same id and type
                      if (targetArray) {
                        existingPurchaseIndex = targetArray.findIndex(p => {
                          const pId = p.id || p.courseId || p.testId || p._id;
                          const pType = p.purchaseType || p.type;
                          return pId === purchaseId && pType === type;
                        });
                      }

                      // If existing purchase found, update it (renewal)
                      if (existingPurchaseIndex >= 0 && targetArray) {
                        // Update existing purchase with new validity dates
                        targetArray[existingPurchaseIndex] = {
                          ...targetArray[existingPurchaseIndex],
                          ...purchaseData, // Update with new purchase data
                          // Preserve original purchase info but update dates
                          purchasedAt: purchaseData.purchasedAt,
                          expiresAt: purchaseData.expiresAt,
                          courseValidity: purchaseData.courseValidity,
                          validityValue: purchaseData.validityValue,
                          validityUnit: purchaseData.validityUnit
                        };
                        console.log('Purchase renewed - updated validity dates');
                      } else {
                        // New purchase - add to appropriate array
                        if (type === 'course') {
                          userPurchases[userId].courses.push(purchaseData);
                        } else if (type === 'test') {
                          userPurchases[userId].tests.push(purchaseData);
                        } else if (type === 'category' || type === 'exam') {
                          // Categories and exams are stored in courses array but with their type preserved
                          userPurchases[userId].courses.push(purchaseData);
                        }
                        console.log('New purchase added');
                      }

                      localStorage.setItem('userPurchases', JSON.stringify(userPurchases));
                    } catch (e) {
                      console.warn('Error saving purchase to localStorage:', e);
                    }

                    alert('Payment successful! Redirecting to dashboard...');
                    window.location.href = 'dashboard.html';
                  } else {
                    alert('Payment verification failed: ' + (verifyData.message || 'Unknown error'));
                    buyBtn.disabled = false;
                    buyBtn.textContent = 'Buy Now';
                  }
                } catch (err) {
                  console.error('Error verifying payment:', err);
                  alert('Error verifying payment. Please contact support.');
                  buyBtn.disabled = false;
                  buyBtn.textContent = 'Buy Now';
                }
              },
              modal: {
                ondismiss: function() {
                  buyBtn.disabled = false;
                  buyBtn.textContent = 'Buy Now';
                }
              }
            };

            const rzp = new Razorpay(options);
            rzp.open();
          } catch (err) {
            console.error('Payment error:', err);
            alert('Error initiating payment: ' + (err.message || 'Unknown error'));
            buyBtn.disabled = false;
            buyBtn.textContent = 'Buy Now';
          }
        };
      };

      const loadDetails = async () => {
        if (!type || !entityId) {
          showError('Missing or invalid detail request.');
          return;
        }

        try {
          let item = null;
          let relatedCourses = [];
          let categoryName = '';
          let derivedCategoryId = initialCategoryId || null;
          let currentCourseId = null;

          if (type === 'category') {
            const categories = await fetchCategories();
            item = categories.find(cat => getEntityId(cat) === entityId);
            if (item) {
              derivedCategoryId = getEntityId(item);
              relatedCourses = await fetchCourses(derivedCategoryId);
            }
          } else if (type === 'exam') {
            const exams = await fetchExams();
            item = exams.find(exam => getEntityId(exam) === entityId);
            if (item) {
              derivedCategoryId = item.categoryId || derivedCategoryId;
              if (derivedCategoryId) {
                const categories = await fetchCategories();
                const category = categories.find(cat => getEntityId(cat) === derivedCategoryId);
                categoryName = category ? category.name || '' : '';
                relatedCourses = await fetchCourses(derivedCategoryId);
              }
            }
          } else if (type === 'course') {
            currentCourseId = entityId;
            const categoryIdToUse = derivedCategoryId;
            if (categoryIdToUse) {
              const courses = await fetchCourses(categoryIdToUse);
              item = courses.find(course => getEntityId(course) === entityId);
              relatedCourses = courses;
              const categories = await fetchCategories();
              const category = categories.find(cat => getEntityId(cat) === categoryIdToUse);
              categoryName = category ? category.name || '' : '';
            }
          } else {
            showError('Unsupported detail type.');
            return;
          }

          if (!item) {
            showError('No details found for this selection.');
            return;
          }

          const metaItems = [];
          if (item.courseCost) metaItems.push({ label: 'Price', value: item.courseCost });
          if (item.courseValidity) metaItems.push({ label: 'Validity', value: item.courseValidity });
          if ((type === 'exam' || type === 'course') && categoryName) {
            metaItems.push({ label: 'Category', value: categoryName });
          }
          if (item.hasDiscount && item.discountPercent) {
            metaItems.push({ label: 'Discount', value: `${item.discountPercent}%` });
          }

          const description = item.description || '';
          const detailLines = normaliseDetailLines(item.courseDetails || item.details || '');

          renderDetail({
            item,
            metaItems,
            detailLines,
            description,
            relatedCourses,
            categoryName,
            derivedCategoryId,
            currentCourseId
          });
        } catch (err) {
          console.error('Error loading detail:', err);
          showError('Unable to load details right now. Please try again later.');
        }
      };

      loadDetails();
    })();
  </script>
</body>
</html>

